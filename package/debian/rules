#!/usr/bin/make -sf

.PHONY: build build-arch build-indep binary binary-arch binary-indep install install-arch install-indep install-common clean install-indep-doco install-indep-bundles install-indep-units

# The Debian package builder targets this in order to make the package contents.
build:
	package/compile

# The Debian package builder targets this in order to clean the build areas.
clean:
	${RM} debian/files debian/substvars
	for i in guide exec terminal-management service-management systemv-shims systemd-shims upstart-shims bundles run-via-systemd run-kernel-vt run-user-vt ; \
	do \
		${RM} -r debian/nosh-"$$i"/ || exit 1 ; \
	done
	${RM} -r debian/tmp/

# The Debian package builder targets this in order to make the .deb files.
binary: install
	for i in exec terminal-management ; \
	do \
		${RM} debian/substvars ; \
		dpkg-shlibdeps debian/nosh-"$$i"/usr/local/bin/* || exit 1 ; \
		dpkg-gencontrol -pnosh-"$$i" -Pdebian/nosh-"$$i" || exit 1 ; \
	done
	for i in service-management systemv-shims ; \
	do \
		${RM} debian/substvars ; \
		dpkg-shlibdeps debian/nosh-"$$i"/usr/local/bin/* || exit 1 ; \
		dpkg-shlibdeps debian/nosh-"$$i"/usr/local/sbin/* || exit 1 ; \
		dpkg-gencontrol -pnosh-"$$i" -Pdebian/nosh-"$$i" || exit 1 ; \
	done
	for i in guide systemd-shims upstart-shims bundles run-via-systemd run-kernel-vt run-user-vt ; \
	do \
		${RM} debian/substvars ; \
		dpkg-gencontrol -pnosh-"$$i" -Pdebian/nosh-"$$i" || exit 1 ; \
	done
	for i in exec terminal-management service-management systemv-shims systemd-shims upstart-shims guide bundles run-via-systemd run-kernel-vt run-user-vt ; \
	do \
		dpkg -b debian/nosh-"$$i" ../ || exit 1 ; \
	done

install:
	install -d -m 0755 debian/tmp/DEBIAN
	package/export debian/tmp/ debian/tmp/ debian/tmp/
	for i in exec terminal-management service-management systemv-shims systemd-shims upstart-shims guide bundles run-via-systemd run-kernel-vt run-user-vt ; \
	do \
		install -d -m 0755 debian/nosh-"$$i"/DEBIAN || exit 1 ; \
	done
	package/stage debian/tmp debian
	for i in exec bundles run-via-systemd run-kernel-vt run-user-vt ; \
	do \
		for j in preinst postinst prerm postrm ; \
		do \
			if [ -e debian/nosh-"$$i"."$$j" ] ; \
			then \
				cp -a debian/nosh-"$$i"."$$j" debian/nosh-"$$i"/DEBIAN/"$$j" || exit 1 ; \
			fi ; \
		done ; \
	done
