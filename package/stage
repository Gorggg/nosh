#!/bin/sh -e
# See http://skarnet.org./software/compile.html
if [ \! -d package ] || [ \! -d source ] 
then
	echo "You are not in the right directory." 1>&2 
	exit 100
fi
if ! test $# -ge 2
then
	echo "Two arguments are required." 1>&2 
	exit 100
fi

src="${1}"
dest="${2}"
absdest="`readlink -f "${dest}"`/"

# binaries and doco
for i in exec terminal-management service-management terminal-extras systemv-shims systemd-shims upstart-shims debian-shims ;
do
	if test -s package/nosh-"$i".commands1 || test -s package/nosh-"$i".aliases1 ;
	then
		install -d -m 0755 "${dest}"/nosh-"$i"/usr/local/bin 
		install -d -m 0755 "${dest}"/nosh-"$i"/usr/local/man/man1 
	fi
	while read j ;
	do
		ln -f -- "${src}"/bin/"$j" "${dest}"/nosh-"$i"/usr/local/bin/ 
		ln -f -- "${src}"/man/man1/"$j".1 "${dest}"/nosh-"$i"/usr/local/man/man1/ 
	done < package/nosh-"$i".commands1 ;

	if test -s package/nosh-"$i".commands8 || test -s package/nosh-"$i".aliases8 ;
	then
		install -d -m 0755 "${dest}"/nosh-"$i"/usr/local/sbin 
		install -d -m 0755 "${dest}"/nosh-"$i"/usr/local/man/man8 
	fi
	while read j ;
	do
		ln -f -- "${src}"/sbin/"$j" "${dest}"/nosh-"$i"/usr/local/sbin/ 
		ln -f -- "${src}"/man/man8/"$j".8 "${dest}"/nosh-"$i"/usr/local/man/man8/ 
	done < package/nosh-"$i".commands8 ;

	while read c a ;
	do
		ln -f -s "$c" "${dest}"/nosh-"$i"/usr/local/bin/"$a" 
		ln -f -s "$c".1 "${dest}"/nosh-"$i"/usr/local/man/man1/"$a".1 
	done < package/nosh-"$i".aliases1 ;

	while read c a ;
	do
		ln -f -s "$c" "${dest}"/nosh-"$i"/usr/local/sbin/"$a" 
		ln -f -s "$c".8 "${dest}"/nosh-"$i"/usr/local/man/man8/"$a".8 
	done < package/nosh-"$i".aliases8 ;
done
install -d -m 0755 "${dest}"/nosh-exec/bin 
for j in exec nosh
do
	(cd "${dest}"/nosh-exec/usr/local/ && pax -r -w -l -- bin/"$j" "${absdest}"/nosh-exec/)
done
for j in cyclog
do
	(cd "${dest}"/nosh-service-management/usr/local/ && pax -r -w -l -- bin/"$j" "${absdest}"/nosh-exec/)
done
install -d -m 0755 "${dest}"/nosh-service-management/sbin 
install -d -m 0755 "${dest}"/nosh-service-management/bin 
for j in system-control service-manager service-dt-scanner
do
	(cd "${dest}"/nosh-service-management/usr/local/ && pax -r -w -l -- bin/"$j" "${absdest}"/nosh-service-management/)
done
for j in system-manager
do
	(cd "${dest}"/nosh-service-management/usr/local/ && pax -r -w -l -- sbin/"$j" "${absdest}"/nosh-service-management/)
done
install -d -m 0755 "${dest}"/nosh-run-system-manager/sbin 
case "`uname`" in
Linux)	ln -f -s system-manager "${dest}"/nosh-run-system-manager/sbin/init ;;
*BSD)	;;
esac

# more doco
for i in guide ;
do
	install -d -m 0755 "${dest}"/nosh-"$i"/usr/local/share/doc/nosh 
	cp -a -- "${src}"/share/doc/nosh "${dest}"/nosh-"$i"/usr/local/share/doc/ 
done

# bundles
for i in bundles ;
do
	install -d -m 0755 "${dest}"/nosh-"$i"/run
	install -d -m 0755 "${dest}"/nosh-"$i"/var/sv 
	install -d -m 0755 "${dest}"/nosh-"$i"/var/local/sv 
	install -d -m 0755 "${dest}"/nosh-"$i"/etc/service-bundles/services 
	install -d -m 0755 "${dest}"/nosh-"$i"/etc/service-bundles/targets 
	install -d -m 0755 "${dest}"/nosh-"$i"/etc/system-control/convert 
done
install -d -m 0755 "${dest}"/nosh-run-openssh-server/var/sv/
(
cat package/common-services package/common-sockets package/common-ttys 
case "`uname`" in
Linux)	cat package/linux-services package/linux-sockets package/linux-ttys ;;
*BSD)	cat package/bsd-services package/bsd-sockets package/bsd-ttys ;;
esac
) | while read j ;
do
#	cp -a -- "${src}"/sv/"$j" "${dest}"/nosh-bundles/var/sv/
#	cp -a -- "${src}"/sv/cyclog@"$j" "${dest}"/nosh-bundles/var/sv/
	(cd "${src}"/ && pax -r -w -l -- sv/"$j" sv/cyclog@"$j" "${absdest}"/nosh-bundles/var/)
done
while read j ;
do
#	cp -a -- "${src}"/etc/service-bundles/targets/"$j" "${dest}"/nosh-bundles/etc/service-bundles/targets/
	(cd "${src}"/ && pax -r -w -l -- etc/service-bundles/targets/"$j" "${absdest}"/nosh-bundles/)
done < package/standard-targets
while read j ;
do
#	cp -a -- "${src}"/etc/service-bundles/services/mount@"$j" "${dest}"/nosh-bundles/etc/service-bundles/services/
#	cp -a -- "${src}"/etc/service-bundles/services/fsck@"$j" "${dest}"/nosh-bundles/etc/service-bundles/services/
	(cd "${src}"/ && pax -r -w -l -- etc/service-bundles/services/mount@"$j" "${absdest}"/nosh-bundles/)
	(cd "${src}"/ && pax -r -w -l -- etc/service-bundles/services/fsck@"$j" "${absdest}"/nosh-bundles/)
done < package/common-mounts
(
cat package/common-service-aliases 
case "`uname`" in
Linux)	cat package/linux-service-aliases ;;
*BSD)	cat package/bsd-service-aliases ;;
esac
) | while read service j ;
do
	(cd "${src}"/ && pax -r -w -l -- sv/"$j" "${absdest}"/nosh-bundles/var/)
	(cd "${src}"/ && pax -r -w -l -- sv/cyclog@"$j" "${absdest}"/nosh-bundles/var/)
done
(
cat package/common-etc-service-aliases 
case "`uname`" in
Linux)	cat package/linux-etc-service-aliases ;;
*BSD)	cat package/bsd-etc-service-aliases ;;
esac
) | while read service j ;
do
	(cd "${src}"/ && pax -r -w -l -- etc/service-bundles/services/"$j" "${absdest}"/nosh-bundles/)
done
for j in issue.vc
do
#	cp -a -- "${src}"/etc/"$j" "${dest}"/nosh-bundles/etc/
	(cd "${src}"/ && pax -r -w -l -- etc/"$j" "${absdest}"/nosh-bundles/)
done
(
cat package/common-etc-services 
case "`uname`" in
Linux)	cat package/linux-etc-services ;;
*BSD)	cat package/bsd-etc-services ;;
esac
) | while read j ;
do
#	cp -a -- "${src}"/etc/service-bundles/services/"$j" "${dest}"/nosh-bundles/etc/service-bundles/services/
	(cd "${src}"/ && pax -r -w -l -- etc/service-bundles/services/"$j" "${absdest}"/nosh-bundles/)
done

# units
install -d -m 0755 "${dest}"/nosh-run-via-netbsd-rc/usr/local/etc/rc.d 
install -d -m 0755 "${dest}"/nosh-run-via-systemd/usr/local/lib/systemd/system 
install -d -m 0755 "${dest}"/nosh-run-via-systemd/usr/local/lib/tmpfiles.d 
install -d -m 0755 "${dest}"/nosh-run-via-systemd/usr/local/lib/systemd/system-preset 
while read j ;
do
	ln -f -- "${src}"/lib/systemd/system/"$j" "${dest}"/nosh-run-via-systemd/usr/local/lib/systemd/system/
done < package/systemd-services ;
while read j ;
do
	ln -f -- "${src}"/lib/tmpfiles.d/"$j" "${dest}"/nosh-run-via-systemd/usr/local/lib/tmpfiles.d/
done < package/tmpfiles-snippets ;
while read j ;
do
	ln -f -- "${src}"/etc/rc.d/"$j" "${dest}"/nosh-run-via-netbsd-rc/usr/local/etc/rc.d/
done < package/netbsd-rc-scripts ;
for i in bundles run-via-systemd run-via-netbsd-rc run-virtualbox-guest run-freedesktop-system-bus run-freedesktop-kits run-openssh-server run-user-vt run-kernel-vt run-appletalk run-udev run-busybox-mdev run-suckless-mdev run-vdev run-local-syslog run-klog run-pcbsd-base run-trueos-base
do
	install -d -m 0755 "${dest}"/nosh-"$i"/usr/local/etc/system-control/presets 
	(
	cat package/common-nosh-"$i"-presets
	case "`uname`" in
	Linux)	cat package/linux-nosh-"$i"-presets ;;
	*BSD)	cat package/bsd-nosh-"$i"-presets ;;
	esac
	) | while read j ;
	do
		ln -f -- "${src}"/etc/system-control/presets/"$j" "${dest}"/nosh-"$i"/usr/local/etc/system-control/presets/
	done
done
while read j ;
do
	ln -f -- "${src}"/lib/systemd/system-preset/"$j" "${dest}"/nosh-run-via-systemd/usr/local/lib/systemd/system-preset/
done < package/systemd-presets ;

# Conversion tools
while read j ;
do
	ln -f -- "${src}"/etc/system-control/convert/"$j" "${dest}"/nosh-bundles/etc/system-control/convert/
done < package/conversion-tools
